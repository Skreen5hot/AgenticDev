# .github/workflows/ci.yml

name: CI, Security & Preview Deploy

on:
  push:
    branches: [ "**" ] 
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install
      - name: Run tests
        run: npm test
      - name: Run security audit
        run: npm run security-check

---

  deploy:
    # ðŸŽ¯ FIX: REMOVED IF CONDITION - This job will NOW ALWAYS RUN.
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # --- Conditional Test Step (The key for debugging) ---
      - name: Conditional Branch Log (MAIN)
        # This step only runs if the branch is exactly 'main'
        if: github.ref == 'refs/heads/main'
        run: echo "--- LOGIC SUCCESS: Detected PRODUCTION branch (MAIN) ---"

      - name: Conditional Branch Log (DEV)
        # This step only runs if the branch is exactly 'dev'
        if: github.ref == 'refs/heads/dev'
        run: echo "--- LOGIC SUCCESS: Detected DEV branch (/dev) ---"
        
      - name: Conditional Branch Log (OTHER)
        # This step runs if the branch is neither 'main' nor 'dev'
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/dev'
        run: echo "--- LOGIC SUCCESS: Detected FEATURE/OTHER branch (${{ github.ref_name }}) ---"
      # ---------------------------------------------------

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build 

      - name: Setup Pages
        uses: actions/configure-pages@v5 

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist' 

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
